----
title:    "Sn50 random notes on R"
subtitle: "many while taking stat or epi classes"
date:     '2022'
output:   html_document
----


This is my notebook/scratchpad for R notes.
The basic stuff was in 
[psg/R.html](https://tin6150.github.io/psg/R.html)
but as class uses more advance constructs, and the graphics, 
it is just easier to have Rmd to play with the code in R studio as well.
Knit to html and the result is still visible in the web :)

(gis class may need a Rgis.Rmd, dont put those here)

html is like 4M, trying to keep PSG from over growth, so moving this Rnote
to 
https://tin6150.github.io/covid19_care_capacity_map/Rnote.html

other Rgis.html Rmd would follow.


xref:
 - PHW251 wk11 has lot of visuals, plot_ly, DT data table, 
 - [PHW251 bonus problem set](https://tin6150.github.io/psg/R_phw251_bonus_problem_set.html) 
   practiced on some of them, as well as a gis choropleth.
  



```{r load library, message = FALSE, warning = FALSE, include=F, echo=F}
#### even include=F, code block is executed when knitting!
#install.packages(pacman)
library(pacman)
p_load(DT)
p_load(dplyr)

```

This example from wk 13 of PHW251 on epicurves by Manasa Susarla:
[PHW251 R for Public Health--Fall 2022 git repo](https://github.com/PHW290/PHW251_Fall2022)

ref for Rmd, knit options, latex:
[ds4ps](https://ds4ps.org/cpp-526-fall-2019/labs/r-markdown-files.html)

~~~~

easystats produces nice plots and way less coding that ggplot!

./weekly material/week_13/epi_R_handbook/epi_R_handbook.Rmd

also discussed in
<A HREF="https://epirhandbook.com/en/index.html">The Epidemiologist R Handbook</A>
is by Neale Batra et al. and is also available on the web for free.

(covered glm - generalized linear model, for multivariate?)


```{r chunk name here, include=F, echo=F, eval=F}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# eval=F will prevent knit from running this block
# decent ref for Rmd https://ds4ps.org/cpp-526-fall-2019/labs/r-markdown-files.html


p_load(easystats)

model_dummy = data.frame( c( 1,2,3) , c(2,4,6) )
model0 = model_dummy
# ++ go back to the source to see how model0 was defined

#model0 %>%  model_parameters(exponentiate = TRUE) %>%  plot()

model1 <- glm(outcome ~ age_cat, family = "binomial", data = linelist)
model2 <- glm(outcome ~ age_cat + gender, family = "binomial", data = linelist)

lmtest::lrtest(model1, model2)

```

```{r chunk name cannot repeats or knit fails, include=T, echo=T}

# author: "Manasa Susarla"
# epidemic curvee (wk 13 of PHW251 EpidemicCurves.Rmd)

library(tidyverse)
library(magrittr)
library(pacman)
pacman::p_load(rio)
pacman::p_load(incidence2)

Ebola_data <- import("https://github.com/appliedepi/epirhandbook_eng/raw/master/data/case_linelists/linelist_cleaned.xlsx")
head(Ebola_data)

##First make sure that your date column is in Date Format
Ebola_data$date_onset <- as.Date(Ebola_data$date_onset)

#Step 1: Create an incidence object
epi_day <- incidence(x = Ebola_data, date_index = date_onset, interval = "day")

#Step 2: Plot
plot(epi_day)


# so much simpler than ggplot !

```

epiR and epitools
(wk13 PHW251 Yifan)

```{r}
dummy=1

```

## TBD

- incidence
- incidence2 (wk13 PHW251)
- tableone     # format table for journal publication, compacting, etc.
- maybe purrr map_df() ... 



# string, regex

[string cheatsheet](https://github.com/rstudio/cheatsheets/blob/main/strings.pdf)

for	    use
|	      /|
/	      //
.       \\.      # literal period
!       \\!
?       \\?
\\      \\\\
(       \\()
)       \\)
\t      \\t      # tab
\n      \\n      # newline
\d      \\d      # :digits:


[[:punct:]]
[[:alpha:]]
[[:ASCII:]]		# ascii chars (7 bit?, ie the 127 chars set)
[^[:digit:]]		# everything but numerals  ^ means complement in reqgex, 

\0 				NULL
\nnn				octal code char, 1-3 digits
\xnn				hex   code char, 1-2 digits
\unnn		\u{nnnn}	unicode char, 1-4 digits
\unnnnnnn	\u{nnnnnnnn}	unicode char, 1-8 digits

```{r str_regex}

p_load(stringr)

# hoping to find equiv of $1 $2 perl equiv of (\w+).fasta 

str1="chi_A11.fasta"
str2="A1.fasta"


str_extract( str1, "([\\w,\\d]+)\\.fasta$" )
# nah


# by using () around the pattern, str_match return additional array elements
base = str_match( str1, "([\\w\\d_]+)\\.fasta$" )
base
base[2]  # this does get the basename without the extension


base = str_match( str1, "([\\w\\d_]+)\\.(fasta)$" )
base
base[3]



baseB = str_match( str1, "[\\w\\d_]+\\.fasta$" )
baseB

result =  str1 %>% str_match( "([\\w\\d_]+)\\.fasta$" )
result[2]

# the following don't work 
#result =  str1 %>% str_match( "([\\w\\d_]+)\\.fasta$" )[2]
#result[2]

# so how to grab pattern 2?! into a col of a df??

df_strEg = data_frame( str1, str2 )

df_strEg2 = data_frame(id = 1:7,
       name = c('this and it pretty long is a',
                'name is a',
                'so and so and so and so  and so',
                "chi_B99.fasta",
                "C9.fasta",
                'this is a',
                'this is a variabel name')) 


df_strEg2 %>% 
  mutate_at( "name", str_match, "([\\w\\d_]+)\\.fasta$"  )
  # this can't get to [2] :-\
#df_strEg2

df_strEg2$name %>% 
  str_match( "([\\w\\d_]+)\\.(fasta)$" )


# ok! this works as desired!
df_result3 = df_strEg2 %>% 
  mutate( base = str_match( name, "([\\w\\d_]+)\\.fasta$"  )[,2] )
  
df_result3







```

# named colors in R


table in R.html, maybe move here... except that r studio like to mess with tab



color name	  compatibility	approx hex code
-----------	  ------------	---------------
red     		  r,p?,h?		0xFF0000 ?
green		      r,p?,h?		0x00FF00 ?
blue		      r,p?,h?		0x0000ff ?

darkorange	  r
darkcyan	    r
darklateblue	r

lightgreen    r

compat: r = R, p = python, h = HTML

```{r named_colors}

library(plotly)

x = c( 1, 2, 3 )
y = x

tried_color_list=c(
"grey",
"lightgrey"
)

plot1 = plot_ly(
  x = ~x,
  y = ~y,
  type = "bar",
  marker = list( color = tried_color_list[1] ),    # add color as item 1 and try running code :)
  data = as.data.frame( tried_color_list )
)


plot1

```

# Vector vs scalar
(PHW251 bonus problem Q5)

```{r vector_vs_scalar_logical_comparison}
# understand these comparison first:
myMix = c( 5.1, 5.2, 11.1, 11.2 )
myMix >= 9
myMix >= as.vector(9)
as.numeric( myMix >= 9 )
# ie, result is a list.  IF-statement cant handle list in the THEN and ELSE parts
```

```{r if_else}



# manually create some dataframe from scratch as example data

h1 = c( 123,  124)    # cm
h2 = c(  5.6,   6.6)  # ft
w1 = c( 71,    82)
w2 = c(202,   176)

df_Taiwan = data_frame( h1, w1 ) %>% rename( height=h1, weight=w1 )
df_Colo  =  data_frame( h2, w2 ) %>% rename( height=h2, weight=w2 )  


df_both = rbind( df_Taiwan, df_Colo ) # if col name mismatch then cant row bind

df_both

str(df_Taiwan)                 

bmi_metric = function( height, weight ) {
    return( weight / (height/100)^2 )           # single line return here is fine, even for vectorization
}

bmi_imperial <- function(height, weight){
  bmi = (703 * weight)/(height * 12)^2          # this form is not required
  return(bmi)
}


scalar_calculate_bmi = function( height, weight ) {
  #str( height )
  #if( as.numeric(height >= 9 )) {    # this return a list if height is a list...   # need to return via apply()?
  if( height >= 9 ) {    # if height is a list, it return a list, which return complain is not length 1, which is fine, want this to be scalar comparison only
    #return( bmi_metric(   height,weight ) )   ## for IF-statement, even NOT using the return still cant handle vector
    bmi = bmi_metric(   height,weight )
  } else {
    #return( bmi_imperial( height,weight ) )
    bmi = bmi_imperial( height,weight ) 
  }
  return( bmi )
}


scalar_calculate_bmi( df_Taiwan$height[1], df_Taiwan$weight[1] )   # cuz of the if-statement, only handle scalar input
#scalar_calculate_bmi( df_Taiwan$height,    df_Taiwan$weight    )   # cuz of the if-statement, only handle scalar input



vector_calculate_bmi = function( height, weight ) {
  if_else( height >= as.vector(9),  
    ( bmi_metric(   height,weight ) ),   # do NOT use RETURN in front of these statement, which force return of lenght 1
    ( bmi_imperial( height,weight ) )
  )
}

## see PHW251_Fall2022/problem sets/problem set bonus/problem_set_bonus_beforeCleanUp_lotsOfDetailsOfSubtleVectorization.Rmd
## for all the crazy things i tried 

df_both %>% mutate(
  bmi = vector_calculate_bmi( height, weight )
)

```


```{r, vector_vs_scalar_phw_251_bonus_set_Q11}

# function overloading works in R too :)
# x and y could be vectors, it will do element wise comparison, and return a vector
up_green_down_red = function(x, y) {
  return(ifelse( x <= y, "#fd626e", "#03d584"))
}

```


# stat table calculator


(from R.html)

F(x) = P(X ≤  x)
   	Answer What is  P(X < 27.4) when X has Normal distribution with mean 50 and standard deviation of 20 aka N(50,20).  N often styled as cursive cap N.
   	if variance (σ) is given, use the relation s.d. = sqrt(sigma) 
   	pnorm( q=27.4, mean=50, sd=20, lower.tail=TRUE )
	pnorm( 27.4, 50, 20 )



https://www.bing.com/images/search?view=detailV2&ccid=0m5W4I7i&id=D280CB81A472BCC65596A2A6AAAF0FFFE9900FFE&thid=OIP.0m5W4I7iNeVuNWAygEAEvQHaFj&mediaurl=https%3A%2F%2Fimage.slidesharecdn.com%2Fbusinessstatisticschapter9-160519114719%2F95%2Fbusiness-statistics-chapter-9-28-638.jpg%3Fcb%3D1463658507&cdnurl=https%3A%2F%2Fth.bing.com%2Fth%2Fid%2FR.d26e56e08ee235e56e356032804004bd%3Frik%3D%252fg%252bQ6f8Pr6qmog%26pid%3DImgRaw%26r%3D0&exph=479&expw=638&q=when+to+reject+null+hypothesis+p-value&simid=608004671995271148&form=IRPRST&ck=7010A98F3A1E4976BC1BA694406D033F&selectedindex=1&ajaxhist=0&ajaxserp=0&pivotparams=insightsToken%3Dccid_BYpTD9%252Ba*cp_1F329B75E25E5E43155CF677D62073D5*mid_EF64F8CFAC485FCB18A3749907B64FD3C796FF50*simid_608042167058510911*thid_OIP.BYpTD9-aYUl4li4z6AsFTAHaFj&vt=0&sim=11&iss=VSI

```{r stat table calculator}

# R use log for natural log, but can redefine/alias ln as:
`ln` = log


qnorm( 0.05, lower.tail=F )  # 1.65
# eg: got p-value of 0.0668 >= alpha of 0.05, do not reject (NULL)     ie not stat significant
# test stat of 1.50 is below the 1.645 cut off, do not reject (NULL)


pnorm( q=.95, mean=0, sd=1, lower.tail=F )
pnorm( q=.05, mean=0, sd=1, lower.tail=T )

paup1 = 3.841
paup1 = -2*( ln(558162.2) - ln(605229.7) ) 

pchisq( q=paup1, df=2 )
dchisq( x=.995, df=1 )
dchisq( .975, df=1 )



# most freq used chisq 95% df=1 is 3.841 # JH memorize this
qchisq( 0.95, df=1 )
qchisq( 0.05, df=1, lower.tail=F )

pchisq( 3.841,    df=1 )
pchisq( 3.841459, df=1 )
# pchisq always upper.tail from STAT142... but situation/context??
# pchisq( 3.841459, df=1, lower.tail=F )

qchisq( 0.95, df=2   )  # 5.991465
qchisq( 0.95, df=1.5 )  # 4.980195
qchisq( 0.95, df=1.1 )  # 4.083997
qchisq( 0.95, df=1   )  # 3.841
qchisq( 0.95, df=0.9 )  # 3.58
qchisq( 0.95, df=0.5 )  # 2.420232 
qchisq( 0.95, df=0.1 )  # 0.5318646
qchisq( 0.95, df=0   )  # 0



paup1 = -2*( ln(558162.2) - ln(605229.7) ) 
paup2 = -2*( log(558162.2) - log(605229.7) ) 


#-ln L  2909255.8  # nst=2
#-ln L  2891898.8  # nst=6

paup_hky = -2*( ln(2909255.8) - ln(2891898.8) )

paup_hky # -0.011968


```

# Rmd/Rstudio quirkyness

the triple-backticks r code block.
either don't have name in them,
but if there is, make sure they are unique, or knit will fail.
I suppose if not knitting then don't matter.


# Good resources

<LI><A HREF="https://argoshare.is.ed.ac.uk/healthyr_book/">R for Health Data Science</A>
is an online book by Ewen Harrison and Riinu Pius. It's available online in its entirety, for free
<LI><A HREF="https://epirhandbook.com/en/index.html">The Epidemiologist R Handbook</A>
is by Neale Batra et al. and is also available on the web for free.


# xref


- [PHW251 R for Public Health--Fall 2022 git repo](https://github.com/PHW290/PHW251_Fall2022)
- [PHW251 project hostec by Github Pages](https://pages.github.com/) and is accessible at :
[https://tin6150.github.io/phw251_group_z/milestone4_groupZ.html](https://tin6150.github.io/phw251_group_z/milestone4_groupZ.html) and
[https://tin6150.github.io/phw251_group_z/milestone5_groupZ.html](https://tin6150.github.io/phw251_group_z/milestone5_groupZ.html)

- <A HREF="https://www.rstudio.com/resources/cheatsheets/">list of R cheatsheets</A>


````{r, function_factory_stat241_lab1_q3}

# pi  # predefined

# this is what Xin had for the lab, screenshoted
# yet doesn't work for me here.

Q3.5_Fac <- function( l , r ) {
  res <- function( t ) {                      # define a new fun, assignment    ## syntax for R, a bit weired, but works
      y <- l * sin( t * 2 * pi / r )
     return( y )
  }
  return( res )      # return fn!
}


## i dunno, this just seems to be defining a function inside another function
## nested fn def.
## oh, i guess "res" is not a value obj, but a fn (think of c pointer to fn?)

Q3.6 <- Q3.5_Fac( 5, 12 )
str( Q3.6 )
## actually, R is subtle indeed
## Q3.6 below is not a value, but a fn!  (look at env panel)


t_val = seq(0, 12, 0.1)


plot( t_val, Q3.6(t_val), type="l")

```


